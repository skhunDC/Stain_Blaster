<!doctype html>
<!-- Kiosk build: audio & restricted APIs removed -->
<html lang="en" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stain Blaster – Dublin Cleaners</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
      .stain {
        position: absolute;
        filter: drop-shadow(2px 2px 3px rgba(0, 0, 0, 0.4));
        z-index: 10;
      }
      .glitch-cannon {
        position: fixed;
        width: 220px;
        height: auto;
        bottom: calc(env(safe-area-inset-bottom, 0px) + 1rem);
        right: calc(env(safe-area-inset-right, 0px) + 1rem);
        transform-origin: bottom right;
        pointer-events: none;
        z-index: 50;
      }
      .glitch-shell {
        position: relative;
        display: inline-block;
        transform-origin: center;
      }
      .glitch-shell .glitch-main {
        display: block;
        width: 100%;
        height: auto;
      }
      .glitch-shell .glitch-layer {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        opacity: 0;
        pointer-events: none;
        mix-blend-mode: screen;
      }
      .glitch-shell .glitch-layer--red {
        filter: hue-rotate(-45deg) saturate(260%) brightness(1.2);
      }
      .glitch-shell .glitch-layer--cyan {
        filter: hue-rotate(160deg) saturate(240%) brightness(1.2);
      }
      #logo .glitch-main {
        filter: drop-shadow(0 18px 38px rgba(16, 185, 129, 0.35));
      }

      #highScoreModal {
        touch-action: none;
      }

      #highScoreModal .kb-row {
        display: flex;
        flex-wrap: wrap;
        gap: 0.75rem;
        justify-content: center;
      }

      #highScoreModal .kb-key {
        min-width: 72px;
        padding: 1rem 1.2rem;
        font-size: 1.75rem;
        font-weight: 800;
        border-radius: 1.1rem;
        background: linear-gradient(145deg, #d1fae5, #6ee7b7);
        color: #064e3b;
        border: none;
        box-shadow: 0 18px 32px rgba(16, 185, 129, 0.35);
        transition: transform 0.1s ease, box-shadow 0.1s ease;
      }

      #highScoreModal .kb-key:active {
        transform: scale(0.94);
        box-shadow: 0 8px 16px rgba(16, 185, 129, 0.45);
      }

      #highScoreModal .kb-key--wide {
        min-width: 120px;
      }

      #highScoreModal .kb-key--xl {
        min-width: 200px;
      }

      #highScoreModal .kb-key--action {
        background: linear-gradient(145deg, #34d399, #047857);
        color: #ecfdf5;
      }

      #highScoreModal .kb-key--secondary {
        background: linear-gradient(145deg, #fde68a, #f59e0b);
        color: #78350f;
      }

      .bubble {
        position: absolute;
        pointer-events: none;
        filter: drop-shadow(0 20px 32px rgba(16, 185, 129, 0.35));
        transform-origin: center;
        text-shadow: 0 2px 6px rgba(16, 185, 129, 0.35);
      }
      .bubble::before {
        content: "";
        position: absolute;
        bottom: -14px;
        left: 50%;
        transform: translateX(-50%);
        border-width: 14px 14px 0 14px;
        border-style: solid;
        border-color: #10b981 transparent transparent transparent;
      }
      .bubble::after {
        content: "";
        position: absolute;
        bottom: -11px;
        left: 50%;
        transform: translateX(-50%);
        border-width: 11px 11px 0 11px;
        border-style: solid;
        border-color: rgba(255, 255, 255, 0.95) transparent transparent
          transparent;
      }
      @keyframes bubble-in {
        0% {
          transform: scale(0.45);
          opacity: 0;
        }
        55% {
          transform: scale(1.18);
        }
        75% {
          transform: scale(0.96);
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }
      @keyframes bubble-out {
        to {
          transform: scale(0.8);
          opacity: 0;
        }
      }

      @keyframes bubble-glow {
        0%,
        100% {
          transform: translateY(0) scale(1);
          filter: drop-shadow(0 20px 32px rgba(16, 185, 129, 0.35));
        }
        50% {
          transform: translateY(-8px) scale(1.05);
          filter: drop-shadow(0 28px 38px rgba(16, 185, 129, 0.45));
        }
      }

      @keyframes flash {
        0%,
        50%,
        100% {
          opacity: 1;
        }
        25%,
        75% {
          opacity: 0;
        }
      }

      .flash {
        animation: flash 1s infinite;
      }

      .glitch-active .glitch-main {
        animation: logo-glitch-base 1.1s steps(2, end);
      }
      .glitch-active .glitch-layer--red {
        animation: logo-glitch-layer-red 1.1s steps(2, end);
      }
      .glitch-active .glitch-layer--cyan {
        animation: logo-glitch-layer-cyan 1.1s steps(2, end);
      }

      @keyframes logo-glitch-base {
        0%,
        12%,
        20%,
        55%,
        65%,
        82%,
        90%,
        100% {
          transform: translate3d(0, 0, 0);
        }
        13% {
          transform: translate3d(-2px, 1px, 0) skewX(-2deg);
        }
        15% {
          transform: translate3d(3px, -2px, 0) skewX(2deg);
        }
        18% {
          transform: translate3d(-1px, 1px, 0);
        }
        56% {
          transform: translate3d(2px, -1px, 0) skewX(1deg);
        }
        60% {
          transform: translate3d(-2px, 2px, 0) skewX(-1deg);
        }
        83% {
          transform: translate3d(-1px, -2px, 0);
        }
        86% {
          transform: translate3d(2px, 1px, 0);
        }
      }

      @keyframes logo-glitch-layer-red {
        0%,
        12%,
        20%,
        55%,
        63%,
        82%,
        86%,
        100% {
          opacity: 0;
          transform: translate3d(0, 0, 0);
          clip-path: inset(0 0 0 0);
        }
        13% {
          opacity: 0.7;
          transform: translate3d(-3px, -2px, 0);
          clip-path: inset(0 0 55% 0);
        }
        15% {
          opacity: 0.7;
          transform: translate3d(3px, 1px, 0);
          clip-path: inset(45% 0 0 0);
        }
        18% {
          opacity: 0;
        }
        56% {
          opacity: 0.6;
          transform: translate3d(-2px, 1px, 0);
          clip-path: inset(0 0 65% 0);
        }
        60% {
          opacity: 0.6;
          transform: translate3d(2px, -1px, 0);
          clip-path: inset(35% 0 0 0);
        }
        83% {
          opacity: 0.75;
          transform: translate3d(-3px, 0, 0);
          clip-path: inset(15% 0 45% 0);
        }
      }

      @keyframes logo-glitch-layer-cyan {
        0%,
        12%,
        20%,
        55%,
        60%,
        80%,
        87%,
        100% {
          opacity: 0;
          transform: translate3d(0, 0, 0);
          clip-path: inset(0 0 0 0);
        }
        13% {
          opacity: 0.7;
          transform: translate3d(3px, 1px, 0);
          clip-path: inset(45% 0 0 0);
        }
        15% {
          opacity: 0.7;
          transform: translate3d(-2px, -1px, 0);
          clip-path: inset(0 0 40% 0);
        }
        18% {
          opacity: 0;
        }
        57% {
          opacity: 0.6;
          transform: translate3d(2px, -2px, 0);
          clip-path: inset(20% 0 40% 0);
        }
        84% {
          opacity: 0.7;
          transform: translate3d(2px, 2px, 0);
          clip-path: inset(60% 0 0 0);
        }
      }
    </style>
  </head>
  <body class="h-full bg-white overflow-hidden">
    <!-- Attract / Start Screen -->
    <div
      id="startScreen"
      class="absolute inset-0 flex flex-col items-center justify-center gap-8 bg-white touch-none select-none"
    >
      <div
        id="logo"
        class="glitch-shell relative w-72 md:w-80 max-w-sm drop-shadow-2xl transition-transform duration-700 ease-out"
      >
        <img
          src="https://www.dublincleaners.com/wp-content/uploads/2025/06/LogosHQ.png"
          alt="Dublin Cleaners"
          class="glitch-main"
        />
        <img
          src="https://www.dublincleaners.com/wp-content/uploads/2025/06/LogosHQ.png"
          alt=""
          aria-hidden="true"
          class="glitch-layer glitch-layer--red"
        />
        <img
          src="https://www.dublincleaners.com/wp-content/uploads/2025/06/LogosHQ.png"
          alt=""
          aria-hidden="true"
          class="glitch-layer glitch-layer--cyan"
        />
      </div>
      <div class="text-5xl font-bold text-stone-700 text-center leading-tight">
        Stain Blaster
      </div>
      <div class="text-xl text-stone-500 text-center">
        Swipe the stains away in 12 seconds<br />Win cleaning tips, prizes, and
        dry cleaning discounts!
      </div>
      <div class="text-xs text-stone-400 text-center max-w-md px-4">
        Disclaimer<br />
        By pressing "Play Now", you understand this content provides general
        fabric care tips only. Always follow the care labels on your garments
        and be aware of any restrictions. Use these tips at your own risk—Dublin
        Cleaners is not responsible for any damage that may result from misuse
        or disregard of proper care instructions.
      </div>
      <button
        id="playBtn"
        class="px-6 py-3 bg-emerald-600 text-white text-2xl rounded-2xl shadow-lg active:scale-95 transition"
      >
        Play Now
      </button>
      <div
        id="attractCannon"
        class="glitch-shell glitch-cannon select-none"
        aria-hidden="true"
      >
        <img
          src="https://www.dublincleaners.com/wp-content/uploads/2025/08/Canon.png"
          alt=""
          class="glitch-main"
        />
        <img
          src="https://www.dublincleaners.com/wp-content/uploads/2025/08/Canon.png"
          alt=""
          class="glitch-layer glitch-layer--red"
        />
        <img
          src="https://www.dublincleaners.com/wp-content/uploads/2025/08/Canon.png"
          alt=""
          class="glitch-layer glitch-layer--cyan"
        />
      </div>
    </div>


    <!-- Game Area -->
    <div
      id="gameArea"
      class="absolute inset-0 hidden bg-[url('https://www.dublincleaners.com/wp-content/uploads/2025/08/Whiteshirt.png')] bg-cover"
    >
      <!-- stains injected here -->
      <div
        id="cannon"
        class="glitch-shell glitch-cannon select-none"
        aria-hidden="true"
      >
        <img
          src="https://www.dublincleaners.com/wp-content/uploads/2025/08/Canon.png"
          alt=""
          class="glitch-main"
        />
        <img
          src="https://www.dublincleaners.com/wp-content/uploads/2025/08/Canon.png"
          alt=""
          class="glitch-layer glitch-layer--red"
        />
        <img
          src="https://www.dublincleaners.com/wp-content/uploads/2025/08/Canon.png"
          alt=""
          class="glitch-layer glitch-layer--cyan"
        />
      </div>
      <div
        id="timer"
        class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-8xl font-black text-yellow-400 drop-shadow-lg"
      >
        12
      </div>
    </div>

    <!-- Result Screen -->
    <div
      id="resultScreen"
      class="absolute inset-0 hidden flex flex-col items-center justify-center gap-6 bg-white text-center"
    >
      <div
        id="resultText"
        class="flex flex-col items-center gap-4 text-center"
      ></div>
      <div id="qrWrap" class="p-4 bg-stone-100 rounded-2xl shadow-inner"></div>
      <button
        id="restartBtn"
        class="mt-8 px-6 py-3 bg-emerald-600 text-white text-2xl rounded-2xl shadow-lg active:scale-95 transition"
      >
        Play Again
      </button>
    </div>

    <div
      id="highScoreModal"
      class="hidden absolute inset-0 z-[120] flex items-center justify-center bg-emerald-950/80 px-4"
      role="dialog"
      aria-modal="true"
      aria-labelledby="highScoreModalTitle"
    >
      <div
        class="w-full max-w-3xl rounded-[2.5rem] border-4 border-emerald-500 bg-white px-6 py-8 text-center shadow-2xl md:px-12 md:py-12"
      >
        <div
          id="highScoreModalTitle"
          class="text-4xl font-black uppercase tracking-wide text-emerald-600 drop-shadow"
        >
          New Su-Stained High Score!
        </div>
        <div class="mt-4 text-lg text-stone-600">
          Touch the keyboard below to add your name to the leaderboard.
        </div>
        <div class="mt-6">
          <input
            id="highScoreNameInput"
            type="text"
            inputmode="none"
            autocomplete="off"
            maxlength="18"
            readonly
            class="w-full rounded-[1.75rem] border-4 border-emerald-500 bg-emerald-50 px-6 py-4 text-center text-3xl font-black tracking-widest text-emerald-700 shadow-inner"
            placeholder="ENTER YOUR NAME"
          />
          <div id="highScoreNotice" class="mt-2 h-6 text-sm font-semibold text-rose-500"></div>
        </div>
        <div id="highScoreKeyboard" class="mt-6 flex flex-col items-center gap-4">
          <div class="kb-row">
            <button class="kb-key" data-key="Q">Q</button>
            <button class="kb-key" data-key="W">W</button>
            <button class="kb-key" data-key="E">E</button>
            <button class="kb-key" data-key="R">R</button>
            <button class="kb-key" data-key="T">T</button>
            <button class="kb-key" data-key="Y">Y</button>
            <button class="kb-key" data-key="U">U</button>
            <button class="kb-key" data-key="I">I</button>
            <button class="kb-key" data-key="O">O</button>
            <button class="kb-key" data-key="P">P</button>
          </div>
          <div class="kb-row">
            <button class="kb-key" data-key="A">A</button>
            <button class="kb-key" data-key="S">S</button>
            <button class="kb-key" data-key="D">D</button>
            <button class="kb-key" data-key="F">F</button>
            <button class="kb-key" data-key="G">G</button>
            <button class="kb-key" data-key="H">H</button>
            <button class="kb-key" data-key="J">J</button>
            <button class="kb-key" data-key="K">K</button>
            <button class="kb-key" data-key="L">L</button>
          </div>
          <div class="kb-row">
            <button class="kb-key" data-key="Z">Z</button>
            <button class="kb-key" data-key="X">X</button>
            <button class="kb-key" data-key="C">C</button>
            <button class="kb-key" data-key="V">V</button>
            <button class="kb-key" data-key="B">B</button>
            <button class="kb-key" data-key="N">N</button>
            <button class="kb-key" data-key="M">M</button>
            <button class="kb-key kb-key--wide" data-key="BACKSPACE">⌫</button>
          </div>
          <div class="kb-row">
            <button class="kb-key kb-key--xl" data-key="SPACE">Space</button>
            <button class="kb-key kb-key--wide kb-key--secondary" data-key="CLEAR">Clear</button>
          </div>
          <div class="kb-row">
            <button id="skipHighScoreBtn" class="kb-key kb-key--wide kb-key--secondary" type="button">
              Skip
            </button>
            <button id="saveHighScoreBtn" class="kb-key kb-key--wide kb-key--action" type="button">
              Save Name
            </button>
          </div>
        </div>
      </div>
    </div>

    <div
      id="highScore"
      class="hidden absolute top-2 right-2 z-50 flex flex-col items-center justify-center gap-1 rounded-lg bg-emerald-600 px-5 py-3 text-center text-white shadow-lg"
    ></div>

    <script>
      (async () => {
        // Fallback prize picker in case the module fails to load. This
        // mirrors the logic in prize.js so kiosk users still receive
        // monetary rewards even if dynamic import is blocked.
        let pickPrize = (level) => {
          const prizes = [
            { tier: "Common", probability: 0.6, reward: null, minLevel: 1 },
            {
              tier: "Uncommon",
              probability: 0.25,
              reward: "$5 cleaning credit",
              minLevel: 1,
            },
            {
              tier: "Rare",
              probability: 0.12,
              reward: "$10 cleaning credit",
              minLevel: 2,
            },
            {
              tier: "Epic",
              probability: 0.03,
              reward: "$50 premium garment credit",
              minLevel: 3,
            },
          ];
          const fallback = prizes.find((p) => level >= p.minLevel) || prizes[0];
          const r = Math.random();
          let cumulative = 0;
          for (const p of prizes) {
            cumulative += p.probability;
            if (r < cumulative) {
              return level >= p.minLevel ? p : fallback;
            }
          }
          return fallback;
        };
        try {
          ({ pickPrize } = await import("./prize.js"));
        } catch (err) {
          console.error("Failed to load prize module", err);
        }
        /* ----- Config ----- */

        const BASE_STAIN_START = 23; // initial stains
        const BASE_STAIN_SIZE = 90; // px
        const BASE_FIRE_RATE = 3000; // ms per extra stain
        const TOP_MARGIN = 50;
        const BOTTOM_MARGIN = 100;
        const HIGH_SCORE_CLEARANCE = 16;
        const DEVICE = "kiosk";
        const GAME_TIME = 12; // seconds per round
        const RESET_DELAY = 60000; // ms before auto reset (4x longer)

        let STAIN_START = BASE_STAIN_START;
        let STAIN_SIZE = BASE_STAIN_SIZE;
        let FIRE_RATE = BASE_FIRE_RATE;
        let winStreak = 0;
        let timeOffset = 0; // server vs client clock diff
        let resetTimer;

        if (typeof google !== "undefined") {
          google.script.run
            .withSuccessHandler((t) => {
              timeOffset = t - Date.now();
            })
            .getServerTime();
        }

        function now() {
          return Date.now() + timeOffset;
        }

        function applyDifficulty() {
          STAIN_SIZE = BASE_STAIN_SIZE / Math.pow(1.2, winStreak);
          STAIN_START = Math.round(
            BASE_STAIN_START * Math.pow(1.15, winStreak),
          );
          FIRE_RATE = BASE_FIRE_RATE * Math.pow(0.85, winStreak);
        }

        function computeTopMargin(areaRect = gameArea.getBoundingClientRect()) {
          const base = TOP_MARGIN;
          if (
            !areaRect ||
            highScoreEl.classList.contains("hidden") ||
            highScoreEl.offsetWidth === 0 ||
            highScoreEl.offsetHeight === 0
          ) {
            return base;
          }
          const scoreRect = highScoreEl.getBoundingClientRect();
          if (!scoreRect || (!scoreRect.width && !scoreRect.height)) {
            return base;
          }
          const clearance =
            scoreRect.bottom - areaRect.top + HIGH_SCORE_CLEARANCE;
          return Math.max(base, clearance);
        }
        const STAIN_IMAGES = [
          "https://www.dublincleaners.com/wp-content/uploads/2025/08/Ketchup.png",
          "https://www.dublincleaners.com/wp-content/uploads/2025/08/Coffee.png",
          "https://www.dublincleaners.com/wp-content/uploads/2025/08/Dirt.png",
          "https://www.dublincleaners.com/wp-content/uploads/2025/08/Wine.png",
        ];
        const BUBBLE_LINES = [
          "Think you can wipe all the stains?",
          "Eco cleaning tips & discounts await!",
          "Swipe fast – win prizes toward your dry cleaning bill!",
          "Spotless skills? Earn dry-cleaning credits!",
          "Tap ▶ to blast, learn & save!",
          "Your dry-cleaner believes in you 😎",
          "Beat the Su-Stained High Score!!",
        ];
        const BUBBLE_INTERVAL = 4000; // ms between spawns
        const BUBBLE_JITTER = 1000; // ms random jitter
        const BUBBLE_DURATION = 5000; // ms visible
        const LOGO_GLITCH_INTERVAL = 14000; // ms between glitch triggers
        const LOGO_GLITCH_JITTER = 5000; // ms random offset
        const LOGO_GLITCH_DURATION = 1100; // ms animation length
        const TIP_DISCLAIMER =
          "\n\n<em>Ensure safe for care labels and understand restrictions. ATTEMPT AT YOUR OWN RISK – we are not responsible for any damage you cause to your garment.</em>";
        const cleaningTips = [
          "🧼 <strong>Always blot, never rub</strong>\nSpilled wine or coffee? Gently blot with a clean white cloth—rubbing pushes the stain deeper and can damage delicate fibers." +
            TIP_DISCLAIMER,
          "🚫 <strong>Skip the DIY vinegar on silk</strong>\nNatural doesn’t always mean safe. For fine fabrics like silk or wool, avoid vinegar or baking soda—let a textile expert handle it." +
            TIP_DISCLAIMER,
          "👗 <strong>Use garment bags for more than travel</strong>\nProtect your cashmere, gowns, and couture pieces with breathable garment bags—especially in humid or scented closets." +
            TIP_DISCLAIMER,
          "⏱️ <strong>Treat stains fast—but gently</strong>\nIf you can’t get to us right away, lightly dampen the stain with cold water. Don’t apply heat or soap—it could set the stain permanently." +
            TIP_DISCLAIMER,
          "🌬️ <strong>Air out, don’t over-wash</strong>\nFor suits, coats, and dresses, let them breathe between wears. Over-cleaning can shorten the life of premium fabrics." +
            TIP_DISCLAIMER,
          "📎 <strong>Dry cleaning tags go on the hanger, not the sleeve</strong>\nKeep those paper sleeves off your garments. We return items pressed and ready—hang them, store them, wear them." +
            TIP_DISCLAIMER,
          "💨 <strong>Use a steamer, not an iron</strong>\nSteaming is gentler on delicate fabrics and helps preserve the finish. Perfect for touch-ups between professional cleanings." +
            TIP_DISCLAIMER,
          "👔 <strong>Mind your collars and cuffs</strong>\nThese spots collect oils, makeup, and sweat. If you want your shirts to last longer, pre-treat them or clean them more often." +
            TIP_DISCLAIMER,
          "🪵 <strong>Skip the wire hangers</strong>\nInvest in wooden or padded hangers. Wire hangers can misshape shoulders and leave rust or stretch marks." +
            TIP_DISCLAIMER,
          "🌱 <strong>Eco-cleaning matters—ask your cleaner</strong>\nAt Dublin Cleaners, we use biodegradable solvents that are gentle on fabrics and the planet. Garment care without the guilt." +
            TIP_DISCLAIMER,
        ];

        function genCode() {
          const now = new Date();
          const stamp =
            now.getFullYear().toString() +
            String(now.getMonth() + 1).padStart(2, "0") +
            String(now.getDate()).padStart(2, "0") +
            String(now.getHours()).padStart(2, "0") +
            String(now.getMinutes()).padStart(2, "0") +
            String(now.getSeconds()).padStart(2, "0");
          const rand = Math.random().toString(36).slice(2, 7).toUpperCase();
          return `${stamp}-${rand}`;
        }

        /* ----- DOM refs ----- */
        const startScreen = document.getElementById("startScreen");
        const gameArea = document.getElementById("gameArea");
        const timerEl = document.getElementById("timer");
        const cannon = document.getElementById("cannon");
        const attractCannon = document.getElementById("attractCannon");
        const resultScreen = document.getElementById("resultScreen");
        const resultText = document.getElementById("resultText");
        const qrWrap = document.getElementById("qrWrap");
        const logo = document.getElementById("logo");
        const playBtn = document.getElementById("playBtn");
        const highScoreEl = document.getElementById("highScore");
        const highScoreModal = document.getElementById("highScoreModal");
        const highScoreNameInput = document.getElementById("highScoreNameInput");
        const highScoreKeyboard = document.getElementById("highScoreKeyboard");
        const highScoreNotice = document.getElementById("highScoreNotice");
        const saveHighScoreBtn = document.getElementById("saveHighScoreBtn");
        const skipHighScoreBtn = document.getElementById("skipHighScoreBtn");
        const DEFAULT_HIGH_SCORE_NAME = "STAIN CHAMP";
        const MAX_NAME_LENGTH = 18;
        let pendingHighScore = null;
        let pendingHighScoreTimestamp = 0;
        let remaining,
          total,
          seconds,
          countdown,
          startTime,
          fireInterval,
          bubbleTimer,
          logoTimer,
          resultShown = false;

        const glitchTimers = new Map();

        let inMemoryHighScore = { score: 0, name: "", timestamp: 0 };

        function sanitizeName(name) {
          return String(name || "")
            .replace(/[^A-Za-z0-9 .,'&-]/g, "")
            .replace(/\s+/g, " ")
            .trim()
            .toUpperCase()
            .slice(0, MAX_NAME_LENGTH);
        }

        function loadHighScore() {
          try {
            const stored = localStorage.getItem("sbHighScore");
            if (stored) {
              const parsed = JSON.parse(stored);
              const normalized = {
                score: Math.max(0, Math.floor(Number(parsed?.score) || 0)),
                name: sanitizeName(parsed?.name),
                timestamp:
                  parsed?.timestamp && Number(parsed.timestamp) > 0
                    ? Number(parsed.timestamp)
                    : 0,
              };
              inMemoryHighScore = normalized;
              return normalized;
            }
          } catch {}
          return inMemoryHighScore;
        }

        function saveHighScore(record) {
          const normalizedScore = Math.max(
            0,
            Math.floor(Number(record?.score) || 0),
          );
          const normalizedName = sanitizeName(record?.name);
          const normalizedTimestamp =
            record?.timestamp && Number(record.timestamp) > 0
              ? Number(record.timestamp)
              : normalizedScore > 0
              ? Date.now()
              : 0;
          const normalized = {
            score: normalizedScore,
            name:
              normalizedScore > 0
                ? normalizedName || DEFAULT_HIGH_SCORE_NAME
                : "",
            timestamp: normalizedTimestamp,
          };
          try {
            localStorage.setItem("sbHighScore", JSON.stringify(normalized));
          } catch {}
          inMemoryHighScore = normalized;
          return normalized;
        }

        function updateHighScoreDisplay() {
          const { score, name, timestamp } = loadHighScore();
          if (score > 0) {
            const holder = name || "???";
            const parts = [
              '<div class="text-xs uppercase tracking-wide opacity-90">Su-Stained High Score</div>',
              `<div class="text-4xl font-black leading-tight">${score}</div>`,
              `<div class="text-sm font-semibold">Champion: ${holder}</div>`,
            ];
            if (timestamp > 0) {
              parts.push(
                `<div class="text-[0.7rem] opacity-80">${new Date(
                  timestamp,
                ).toLocaleString()}</div>`,
              );
            }
            highScoreEl.innerHTML = parts.join("");
          } else {
            highScoreEl.innerHTML =
              '<div class="text-xs uppercase tracking-wide opacity-90">Su-Stained High Score</div><div class="text-4xl font-black leading-tight">0</div><div class="text-sm font-semibold">Be the first to set it!</div>';
          }
        }

        function isNewHighScore(score) {
          const { score: prev } = loadHighScore();
          return score > prev;
        }

        function showHighScoreNameEntry(score) {
          pendingHighScore = Math.max(0, Math.floor(score));
          highScoreNameInput.value = "";
          highScoreNotice.textContent = "";
          pendingHighScoreTimestamp = Date.now();
          highScoreModal.classList.remove("hidden");
        }

        function hideHighScoreNameEntry() {
          highScoreModal.classList.add("hidden");
          pendingHighScore = null;
          pendingHighScoreTimestamp = 0;
        }

        function handleVirtualKeyPress(key) {
          if (pendingHighScore === null) return;
          let value = highScoreNameInput.value;
          highScoreNotice.textContent = "";
          if (key === "BACKSPACE") {
            highScoreNameInput.value = value.slice(0, -1);
            return;
          }
          if (key === "CLEAR") {
            highScoreNameInput.value = "";
            return;
          }
          if (key === "SPACE") {
            if (!value.length) {
              highScoreNotice.textContent = "Add some letters first.";
              return;
            }
            if (value.length >= MAX_NAME_LENGTH) {
              highScoreNotice.textContent = "Max characters reached.";
              return;
            }
            if (!value.endsWith(" ")) {
              highScoreNameInput.value = `${value} `;
            }
            return;
          }
          if (value.length >= MAX_NAME_LENGTH) {
            highScoreNotice.textContent = "Max characters reached.";
            return;
          }
          highScoreNameInput.value = `${value}${key}`.slice(0, MAX_NAME_LENGTH);
        }

        function finalizeHighScore(rawName) {
          if (pendingHighScore === null) return;
          const cleaned = sanitizeName(rawName);
          if (!cleaned) {
            highScoreNotice.textContent =
              "Add at least one letter for your name.";
            return;
          }
          saveHighScore({
            score: pendingHighScore,
            name: cleaned,
            timestamp: pendingHighScoreTimestamp || Date.now(),
          });
          updateHighScoreDisplay();
          hideHighScoreNameEntry();
        }

        function skipHighScoreName() {
          if (pendingHighScore === null) return;
          saveHighScore({
            score: pendingHighScore,
            name: DEFAULT_HIGH_SCORE_NAME,
            timestamp: pendingHighScoreTimestamp || Date.now(),
          });
          updateHighScoreDisplay();
          hideHighScoreNameEntry();
        }

        function randomImage() {
          return STAIN_IMAGES[Math.floor(Math.random() * STAIN_IMAGES.length)];
        }

        function randomLine() {
          return BUBBLE_LINES[Math.floor(Math.random() * BUBBLE_LINES.length)];
        }

        function spawnBubble() {
          if (startScreen.classList.contains("hidden")) return;
          if (startScreen.querySelectorAll(".bubble").length >= 3) return;
          const bubble = document.createElement("div");
          bubble.className =
            "bubble max-w-[320px] px-6 py-4 rounded-[2rem] border-[3px] border-emerald-500 bg-gradient-to-br from-white via-emerald-50 to-emerald-100/80 text-emerald-700 font-extrabold text-center text-lg leading-snug tracking-wide shadow-xl ring-4 ring-emerald-200/60 backdrop-blur-sm pointer-events-none";
          bubble.innerHTML = `${randomLine()}<svg class="absolute -top-3 -right-3 w-6 h-6 text-emerald-400 drop-shadow-md" viewBox="0 0 20 20" fill="currentColor"><path d="M10 0l2.09 6.26L18.18 7.5l-5.09 3.7L14.18 18 10 14.27 5.82 18l1.09-6.8L1.82 7.5l6.09-1.24L10 0z"/></svg>`;
          startScreen.appendChild(bubble);
          const rect = startScreen.getBoundingClientRect();
          const maxY = rect.height * 0.6;
          const avoid = [
            logo.getBoundingClientRect(),
            playBtn.getBoundingClientRect(),
          ];
          const bw = bubble.offsetWidth;
          const bh = bubble.offsetHeight;
          const basePaddingX = Math.max(16, rect.width * 0.05);
          const basePaddingY = Math.max(16, rect.height * 0.05);
          const safePaddingX = Math.min(
            basePaddingX,
            Math.max(0, (rect.width - bw) / 2),
          );
          const safePaddingY = Math.min(
            basePaddingY,
            Math.max(0, (maxY - bh) / 2),
          );
          const topLimit = Math.max(
            safePaddingY,
            Math.min(rect.height - safePaddingY - bh, maxY - bh),
          );
          const availableWidth = Math.max(0, rect.width - bw - safePaddingX * 2);
          const availableHeight = Math.max(
            0,
            topLimit - safePaddingY,
          );
          let x,
            y,
            tries = 0,
            ok;
          do {
            x =
              safePaddingX +
              (availableWidth > 0 ? Math.random() * availableWidth : 0);
            y =
              safePaddingY +
              (availableHeight > 0 ? Math.random() * availableHeight : 0);
            ok = !avoid.some((r) => {
              const rx = r.left - rect.left;
              const ry = r.top - rect.top;
              return !(
                x + bw < rx ||
                x > rx + r.width ||
                y + bh < ry ||
                y > ry + r.height
              );
            });
            tries++;
          } while (!ok && tries < 10);
          bubble.style.left = x + "px";
          bubble.style.top = y + "px";
          bubble.style.animation =
            "bubble-in 0.65s cubic-bezier(0.22, 1.28, 0.68, 1.08), bubble-glow 3.8s ease-in-out 0.65s infinite alternate, bubble-out 0.6s ease-in 4.4s forwards";
          setTimeout(() => bubble.remove(), BUBBLE_DURATION);
        }

        function scheduleBubble() {
          if (startScreen.classList.contains("hidden")) return;
          bubbleTimer = setTimeout(
            () => {
              spawnBubble();
              scheduleBubble();
            },
            BUBBLE_INTERVAL + (Math.random() * 2 - 1) * BUBBLE_JITTER,
          );
        }

        function triggerGlitchFor(element) {
          if (!element) return;
          element.classList.remove("glitch-active");
          void element.offsetWidth;
          element.classList.add("glitch-active");
          const timer = glitchTimers.get(element);
          if (timer) {
            clearTimeout(timer);
          }
          const cleanup = setTimeout(() => {
            element.classList.remove("glitch-active");
            glitchTimers.delete(element);
          }, LOGO_GLITCH_DURATION);
          glitchTimers.set(element, cleanup);
        }

        function triggerLogoGlitch() {
          if (!startScreen.classList.contains("hidden")) {
            triggerGlitchFor(logo);
            triggerGlitchFor(attractCannon);
          }
          if (!gameArea.classList.contains("hidden")) {
            triggerGlitchFor(cannon);
          }
        }

        function scheduleLogoGlitch(initialDelay = LOGO_GLITCH_INTERVAL) {
          clearTimeout(logoTimer);
          const jitter = Math.random() * LOGO_GLITCH_JITTER;
          const delay = Math.max(0, initialDelay) + jitter;
          logoTimer = setTimeout(() => {
            triggerLogoGlitch();
            scheduleLogoGlitch(LOGO_GLITCH_INTERVAL);
          }, delay);
        }

        function spawnStain(x, y) {
          const s = document.createElement("img");
          s.src = randomImage();
          s.className = "stain";
          const rect = gameArea.getBoundingClientRect();
          const topMargin = computeTopMargin(rect);
          const spawnW = Math.max(0, rect.width - STAIN_SIZE);
          const spawnH = Math.max(
            0,
            rect.height - STAIN_SIZE - topMargin - BOTTOM_MARGIN,
          );
          if (x === undefined) {
            x = Math.random() * spawnW;
          }
          if (y === undefined) {
            y = Math.random() * spawnH + topMargin;
          }
          s.style.left = x + "px";
          s.style.top = y + "px";
          s.style.width = STAIN_SIZE + "px";
          s.style.height = STAIN_SIZE + "px";
          s.style.transform = `rotate(${Math.random() * 360}deg)`;
          const remove = () => {
            s.remove();
            remaining--;
            if (remaining === 0 && seconds > 0) win();
          };
          s.addEventListener("pointerdown", remove);
          gameArea.appendChild(s);
          remaining++;
          total++;
          return s;
        }

        function animateProjectile(el, x0, y0, x1, y1) {
          const duration = 800;
          const arc = 150;
          const start = performance.now();
          function frame(now) {
            const t = Math.min((now - start) / duration, 1);
            const x = x0 + (x1 - x0) * t;
            const y = y0 + (y1 - y0) * t - arc * Math.sin(Math.PI * t);
            el.style.left = x + "px";
            el.style.top = y + "px";
            if (t < 1) {
              requestAnimationFrame(frame);
            } else {
              el.style.left = x1 + "px";
              el.style.top = y1 + "px";
            }
          }
          requestAnimationFrame(frame);
        }

        function fireCannon() {
          const rect = cannon.getBoundingClientRect();
          const area = gameArea.getBoundingClientRect();
          const mouthX = rect.left + rect.width * 0.15 - area.left;
          const mouthY = rect.top + rect.height * 0.15 - area.top;
          const topMargin = computeTopMargin(area);
          const spawnW = Math.max(0, area.width - STAIN_SIZE);
          const spawnH = Math.max(
            0,
            area.height - STAIN_SIZE - topMargin - BOTTOM_MARGIN,
          );
          const targetX = Math.random() * spawnW;
          const targetY = Math.random() * spawnH + topMargin;
          const angle = Math.atan2(targetY - mouthY, targetX - mouthX);
          cannon.style.transform = `rotate(${angle}rad)`;
          const offset = 30;
          const startX = mouthX + Math.cos(angle) * offset;
          const startY = mouthY + Math.sin(angle) * offset;
          const s = spawnStain(startX, startY);
          animateProjectile(s, startX, startY, targetX, targetY);
        }

        function startRound() {
          begin();
          if (typeof google !== "undefined") {
            google.script.run
              .withSuccessHandler((s) => {
                winStreak = s;
              })
              .withFailureHandler(() => {})
              .refreshStreakTimer();
          }
        }

        function begin() {
          if (pendingHighScore !== null) {
            skipHighScoreName();
          } else {
            hideHighScoreNameEntry();
          }
          clearTimeout(resetTimer);
          applyDifficulty();
          startScreen.classList.add("hidden");
          clearTimeout(bubbleTimer);
          startScreen.querySelectorAll(".bubble").forEach((b) => b.remove());
          gameArea.classList.remove("hidden");
          triggerLogoGlitch();
          scheduleLogoGlitch(0);
          gameArea.querySelectorAll(".stain").forEach((s) => s.remove());
          if (!gameArea.contains(timerEl)) gameArea.appendChild(timerEl);
          remaining = 0;
          total = 0;
          resultShown = false;
          updateHighScoreDisplay();
          highScoreEl.classList.remove("hidden");
          for (let i = 0; i < STAIN_START; i++) spawnStain();
          seconds = GAME_TIME;
          timerEl.textContent = seconds;
          startTime = now();
          countdown = setInterval(() => {
            seconds--;
            timerEl.textContent = seconds;
            if (seconds <= 0) {
              clearInterval(countdown);
              clearInterval(fireInterval);
              lose();
            }
          }, 1000);
          fireInterval = setInterval(fireCannon, FIRE_RATE);
        }

        function win() {
          clearInterval(countdown);
          clearInterval(fireInterval);
          // Double-check no stain elements remain before allowing a win
          const stainsLeft = gameArea.querySelectorAll(".stain").length;
          showResult(stainsLeft === 0);
        }

        function lose() {
          showResult(false);
        }

        function setResultMessage(title, body, status) {
          if (!resultText) return;
          resultText.replaceChildren();
          const heading = document.createElement("div");
          const toneClass =
            status === "win" ? "text-emerald-500" : "text-rose-500";
          heading.className = `text-6xl font-black drop-shadow-sm ${toneClass}`;
          heading.textContent = title;
          const bodyEl = document.createElement("div");
          bodyEl.className = "text-2xl font-semibold text-stone-700";
          bodyEl.textContent = body;
          resultText.appendChild(heading);
          resultText.appendChild(bodyEl);
        }

        function showResult(success) {
          if (resultShown) return;
          resultShown = true;
          gameArea.classList.add("hidden");
          resultScreen.classList.remove("hidden");
          qrWrap.innerHTML = "";
          qrWrap.className = "p-4 bg-stone-100 rounded-2xl shadow-inner";
          const payload = {
            score: total - remaining,
            missed: remaining,
            duration: (now() - startTime) / 1000,
            device: DEVICE,
          };
          const tip =
            cleaningTips[Math.floor(Math.random() * cleaningTips.length)];
          if (success) {
            payload.missed = 0;
            payload.score = total;
            const level = winStreak + 1;
            const prize = pickPrize(level);
            payload.prizeTier = prize.tier;
            let code = "";
            const winMessage =
              prize.tier === "Common"
                ? "Great job! Enjoy this cleaning tip 🌱"
                : `Great job! You won ${prize.reward}!`;
            setResultMessage("You Won!", winMessage, "win");
            qrWrap.className =
              "p-6 bg-emerald-50 rounded-2xl shadow-md flex flex-col items-center gap-4 max-w-lg";
            if (prize.tier !== "Common") {
              const prizeWrap = document.createElement("div");
              prizeWrap.className = "relative inline-block";
              const staticEl = document.createElement("div");
              staticEl.className =
                "text-5xl font-extrabold text-yellow-400 text-center drop-shadow-lg";
              staticEl.textContent = prize.reward;
              const flashEl = document.createElement("div");
              flashEl.className =
                "text-5xl font-extrabold text-yellow-400 flash text-center drop-shadow-lg absolute inset-0";
              flashEl.textContent = prize.reward;
              prizeWrap.appendChild(staticEl);
              prizeWrap.appendChild(flashEl);
              qrWrap.appendChild(prizeWrap);
              const noteEl = document.createElement("div");
              noteEl.className = "text-sm text-stone-600 text-center";
              noteEl.textContent =
                "Take a Photo of Credit & Show to CSR & also brag on social media about your win.";
              qrWrap.appendChild(noteEl);
              if (prize.tier === "Epic") {
                const capEl = document.createElement("div");
                capEl.className = "text-xs text-stone-500 text-center";
                capEl.textContent = "1/day cap, manager approval";
                qrWrap.appendChild(capEl);
              }
              const shareEl = document.createElement("div");
              shareEl.className = "text-sm text-stone-600 text-center";
              shareEl.innerHTML =
                'Share with your friends your Winnings & High Scores to social. Tag us @dublincleaners on Facebook and/or Instagram.<span class="inline-flex items-center gap-1 ml-1"><img src="https://cdn.simpleicons.org/facebook/1877F2" alt="Facebook logo" class="h-4 w-4" /><img src="https://cdn.simpleicons.org/instagram/E4405F" alt="Instagram logo" class="h-4 w-4" /></span>';
              qrWrap.appendChild(shareEl);
              code = genCode();
              payload.prizeCode = code;
              const codeEl = document.createElement("div");
              codeEl.className = "font-mono text-lg text-center";
              codeEl.textContent = `Code: ${code}`;
              qrWrap.appendChild(codeEl);
              const disclaimerEl = document.createElement("div");
              disclaimerEl.className = "text-xs text-stone-500 text-center";
              disclaimerEl.innerHTML =
                "Coupon cannot be combined with any other coupons or offers. Limit one coupon per visit per customer. No cash value. Valid only at participating locations. Other restrictions may apply.";
              qrWrap.appendChild(disclaimerEl);
            }
            const tipDiv = document.createElement("div");
            tipDiv.className = "text-xl text-stone-700 whitespace-pre-line";
            tipDiv.innerHTML = tip;
            qrWrap.appendChild(tipDiv);
            confetti();
            if (typeof google !== "undefined") {
              google.script.run
                .withFailureHandler(() => {})
                .logGame(JSON.stringify(payload));
              google.script.run
                .withSuccessHandler((r) => {
                  winStreak = r.winStreak;
                })
                .handleWin();
            } else {
              winStreak = 0;
            }
          } else {
            setResultMessage(
              "You Lost!",
              "Thanks for playing! Tap Play Again to try again.",
              "lose",
            );
            qrWrap.className =
              "p-6 bg-emerald-50 rounded-2xl shadow-md flex flex-col items-center gap-4 max-w-lg";
            const tipDiv = document.createElement("div");
            tipDiv.className = "text-xl text-stone-700 whitespace-pre-line";
            tipDiv.innerHTML = tip;
            qrWrap.appendChild(tipDiv);
            if (typeof google !== "undefined") {
              google.script.run
                .withFailureHandler(() => {})
                .logGame(JSON.stringify(payload));
              google.script.run
                .withSuccessHandler((r) => {
                  winStreak = r.winStreak;
                })
                .withFailureHandler(() => {})
                .resetStreak();
            }
            winStreak = 0;
          }
          if (isNewHighScore(payload.score)) {
            const hsWrap = document.createElement("div");
            hsWrap.className = "relative inline-block";
            const staticEl = document.createElement("div");
            staticEl.className =
              "text-6xl font-extrabold text-rose-500 text-center drop-shadow-lg";
            staticEl.textContent = "New Su-Stained High Score!";
            const flashEl = document.createElement("div");
            flashEl.className =
              "text-6xl font-extrabold text-rose-500 flash text-center drop-shadow-lg absolute inset-0";
            flashEl.textContent = "New Su-Stained High Score!";
            hsWrap.appendChild(staticEl);
            hsWrap.appendChild(flashEl);
            qrWrap.prepend(hsWrap);
            showHighScoreNameEntry(payload.score);
          } else {
            updateHighScoreDisplay();
          }
          clearTimeout(resetTimer);
          resetTimer = setTimeout(() => {
            if (!resultScreen.classList.contains("hidden")) reset();
          }, RESET_DELAY);
        }

        function confetti() {
          if (window.confetti) {
            window.confetti({
              particleCount: 160,
              spread: 90,
              origin: { y: 0.6 },
              zIndex: 1,
            });
          }
        }

        function reset() {
          clearTimeout(resetTimer);
          resultScreen.classList.add("hidden");
          startScreen.classList.remove("hidden");
          resultShown = false;
          if (pendingHighScore !== null) {
            skipHighScoreName();
          } else {
            hideHighScoreNameEntry();
            updateHighScoreDisplay();
          }
          highScoreEl.classList.remove("hidden");
          triggerLogoGlitch();
          scheduleLogoGlitch();
          scheduleBubble();
        }

        highScoreKeyboard.addEventListener("pointerdown", (event) => {
          const keyBtn = event.target.closest("button[data-key]");
          if (!keyBtn) return;
          event.preventDefault();
          handleVirtualKeyPress(keyBtn.dataset.key);
        });

        saveHighScoreBtn.addEventListener("pointerdown", (event) => {
          event.preventDefault();
          finalizeHighScore(highScoreNameInput.value);
        });

        skipHighScoreBtn.addEventListener("pointerdown", (event) => {
          event.preventDefault();
          skipHighScoreName();
        });

        updateHighScoreDisplay();
        highScoreEl.classList.remove("hidden");

        playBtn.addEventListener("pointerdown", () => {
          startRound();
        });
        document
          .getElementById("restartBtn")
          .addEventListener("pointerdown", () => {
            resultScreen.classList.add("hidden");
            startRound();
          });

        triggerLogoGlitch();
        scheduleLogoGlitch();
        scheduleBubble();
      })();
    </script>
  </body>
</html>

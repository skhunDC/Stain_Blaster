<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <title>Stain Blaster â€“ Dublin Cleaners</title>
  <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <style>
    .stain{position:absolute;width:90px;height:90px;filter:drop-shadow(2px 2px 3px rgba(0,0,0,0.4));}
    #cannon{position:absolute;width:80px;height:80px;bottom:1rem;right:1rem;transform-origin:bottom right;pointer-events:none;}
  </style>
</head>
<body class="h-full bg-white overflow-hidden">
  <!-- Attract / Start Screen -->
  <div id="startScreen" class="absolute inset-0 flex flex-col items-center justify-center gap-8 bg-white touch-none select-none">
    <img src="https://www.dublincleaners.com/wp-content/uploads/2025/06/LogosHQ.png" alt="Dublin Cleaners" class="w-56">
    <div class="text-5xl font-bold text-stone-700 text-center leading-tight">Stain Blaster</div>
    <div class="text-xl text-stone-500 text-center">Swipe the stains away in 12 seconds<br>and win an instant reward!</div>
    <button id="playBtn" class="px-6 py-3 bg-emerald-600 text-white text-2xl rounded-2xl shadow-lg active:scale-95 transition">Play Now</button>
  </div>

  <!-- Game Area -->
  <div id="gameArea" class="absolute inset-0 hidden bg-[url('https://www.dublincleaners.com/wp-content/uploads/2025/08/Whiteshirt.png')] bg-cover">
    <!-- stains injected here -->
    <div id="timer" class="absolute top-6 left-1/2 -translate-x-1/2 text-5xl font-bold text-white drop-shadow">12</div>
    <img id="cannon" src="https://www.pngall.com/wp-content/uploads/2017/01/Cannon-PNG-Picture.png" alt="cannon" class="select-none">
  </div>

  <!-- Result Screen -->
  <div id="resultScreen" class="absolute inset-0 hidden flex flex-col items-center justify-center gap-6 bg-white text-center">
    <div id="resultText" class="text-4xl font-semibold text-stone-700"></div>
    <div id="qrWrap" class="p-4 bg-stone-100 rounded-2xl shadow-inner"></div>
    <button id="restartBtn" class="mt-8 px-6 py-3 bg-emerald-600 text-white text-2xl rounded-2xl shadow-lg active:scale-95 transition">
      Play Again
    </button>
  </div>

<script>
(() => {
  /* ----- Config ----- */
  const GAME_TIME   = 12;                 // seconds
  const STAIN_START = 15;                 // initial stains
  const STAIN_SIZE  = 90;                 // px
  const FIRE_RATE   = 3000;               // ms per extra stain
  const STAIN_IMAGES = [
    'https://www.pngall.com/wp-content/uploads/5/Ketchup-Stain-PNG.png',
    'https://www.pngall.com/wp-content/uploads/5/Coffee-Stain-PNG-Free-Download.png',
    'https://www.pngall.com/wp-content/uploads/5/Red-Wine-Stain-PNG-HD.png'
  ];
  const PRIZES      = [                   // cumulative probability table
    {p:0.60, value:5},
    {p:0.85, value:10},
    {p:0.95, value:20},
    {p:0.99, value:25},
    {p:1.00, value:50}
  ];

  /* ----- DOM refs ----- */
  const startScreen = document.getElementById('startScreen');
  const gameArea    = document.getElementById('gameArea');
  const timerEl     = document.getElementById('timer');
  const cannon      = document.getElementById('cannon');
  const resultScreen= document.getElementById('resultScreen');
  const resultText  = document.getElementById('resultText');
  const qrWrap      = document.getElementById('qrWrap');

  let remaining, total, seconds, countdown, startTime, fireInterval;

  function pickPrize(){
    const r = Math.random();
    return PRIZES.find(t => r <= t.p).value;
  }

  function randomImage(){
    return STAIN_IMAGES[Math.floor(Math.random()*STAIN_IMAGES.length)];
  }

  function spawnStain(x,y){
    const s = document.createElement('img');
    s.src = randomImage();
    s.className = 'stain';
    const rect = gameArea.getBoundingClientRect();
    if(x===undefined){ x = Math.random()*(rect.width - STAIN_SIZE); }
    if(y===undefined){ y = Math.random()*(rect.height - STAIN_SIZE - 100) + 50; }
    s.style.left = x+'px';
    s.style.top  = y+'px';
    s.addEventListener('pointerdown',()=>{
      s.remove();
      remaining--;
      if(remaining===0 && seconds>0) win();
    });
    gameArea.appendChild(s);
    remaining++; total++;
    return s;
  }

  function animateProjectile(el,x0,y0,x1,y1){
    const duration = 800;
    const arc = 150;
    const start = performance.now();
    function frame(now){
      const t = Math.min((now-start)/duration,1);
      const x = x0 + (x1-x0)*t;
      const y = y0 + (y1-y0)*t - arc*Math.sin(Math.PI*t);
      el.style.left = x+'px';
      el.style.top  = y+'px';
      if(t<1){
        requestAnimationFrame(frame);
      }else{
        el.style.left = x1+'px';
        el.style.top  = y1+'px';
      }
    }
    requestAnimationFrame(frame);
  }

  function fireCannon(){
    const rect = cannon.getBoundingClientRect();
    const area = gameArea.getBoundingClientRect();
    const startX = rect.left + rect.width*0.2 - area.left;
    const startY = rect.top  + rect.height*0.2 - area.top;
    const targetX = Math.random()*(area.width - STAIN_SIZE);
    const targetY = Math.random()*(area.height - STAIN_SIZE - 100) + 50;
    const angle = Math.atan2(targetY - startY, targetX - startX);
    cannon.style.transform = `rotate(${angle}rad)`;
    const s = spawnStain(startX, startY);
    animateProjectile(s,startX,startY,targetX,targetY);
  }

  function begin(){
    startScreen.classList.add('hidden');
    gameArea.classList.remove('hidden');
    gameArea.innerHTML = '';
    gameArea.appendChild(timerEl);
    gameArea.appendChild(cannon);
    remaining=0; total=0;
    for(let i=0;i<STAIN_START;i++) spawnStain();
    seconds = GAME_TIME;
    timerEl.textContent = seconds;
    startTime = Date.now();
    countdown = setInterval(()=>{
      seconds--;
      timerEl.textContent = seconds;
      if(seconds<=0){
        clearInterval(countdown);
        clearInterval(fireInterval);
        lose();
      }
    },1000);
    fireInterval = setInterval(fireCannon, FIRE_RATE);
  }

  function win(){
    clearInterval(countdown);
    clearInterval(fireInterval);
    showResult(true);
  }

  function lose(){
    showResult(false);
  }

  function showResult(success){
    gameArea.classList.add('hidden');
    resultScreen.classList.remove('hidden');
    qrWrap.innerHTML = '';
    const payload = {
      prize:0, code:'',
      score: total - remaining,
      missed: remaining,
      duration: (Date.now()-startTime)/1000,
      device:'kiosk'
    };
    if(success){
      const prize = pickPrize();
      const code  = `DCGC-${Date.now()}-${prize}`;
      resultText.textContent = `Congrats! You won a $${prize} gift certificate ðŸŽ‰`;
      new QRCode(qrWrap,{text:code,width:256,height:256});
      confetti();
      payload.prize = prize;
      payload.code  = code;
      payload.missed = 0;
      payload.score = total;
    }else{
      resultText.textContent = 'Nice try! Give it another go.';
    }
    if(typeof google !== 'undefined'){
      google.script.run.withFailureHandler(()=>{}).logGame(JSON.stringify(payload));
    }
  }

  function confetti(){
    if(window.confetti){
      window.confetti({particleCount:160, spread:90, origin:{y:0.6}});
    }
  }

  function reset(){
    resultScreen.classList.add('hidden');
    startScreen.classList.remove('hidden');
  }

  document.getElementById('playBtn').addEventListener('click', begin);
  document.getElementById('restartBtn').addEventListener('click', reset);

  setInterval(()=>{
    if(!resultScreen.classList.contains('hidden') &&
       Date.now()-startTime > (GAME_TIME+30)*1000){
      reset();
    }
  },5000);

  if('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').catch(()=>{});
  }
})();
</script>

<!-- Lightweight offline cache (inline for brevity) -->
<script id="sw" type="text/worker">
self.addEventListener('install',e=>{self.skipWaiting();});
self.addEventListener('fetch',e=>{
  e.respondWith(
    caches.open('stainblaster-v1').then(c=>c.match(e.request).then(r=>r||fetch(e.request).then(res=>{
      if(res.ok){ c.put(e.request,res.clone()); }
      return res;
    })))
  );
});
</script>
</body>
</html>
